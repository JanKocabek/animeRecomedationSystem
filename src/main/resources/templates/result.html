<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/core :: head(~{::title},~{fragments/core :: csrfTokens})}">
    <title>Recommendation Result</title>
</head>

<body class="bg-light">
    <!-- Hero Section -->
    <header th:replace="~{fragments/header :: header}"></header>
    <main>
        <!-- Recommendations Section -->
        <section class="py-5">
            <div class="container">
                <h2 class="mb-4"
                    th:text="'Anime Recommendations for: ' + ${#strings.listJoin(recommendations.inputAnimeNames, ', ')}">
                </h2>
                <div class="row g-4">
                    <div th:each="recommend : ${recommendations.getRecommendedAnime()}"
                        class="col-sm-6 col-md-4 col-lg-3">
                        <div class="card shadow-sm h-100">
                            <!-- Image and MAL LINK  -->

                                <a th:href="@{'https://myanimelist.net/anime/' + ${recommend.animeId} + '/'}"
                                    target="_blank" rel="noopener noreferrer" class="text-decoration-none mal-link ">
                                    <img alt="template" th:src="${recommend.animeInfo.imageURL}" th:alt="${recommend.animeInfo.name}"
                                        class="card-img-top img-fluid">
                                </a>

                            <!-- Card Body -->
                            <div class="card-body d-flex flex-column flex-grow-1 ">
                                <!--card-title-->
                                <h5 class="card-title mb-3" th:text="${recommend.animeInfo.name}"></h5>
                                <div class="d-flex flex-column justify-content-center flex-grow-1">
                                    <!--   main columns-->
                                    <div class="card-text d-flex flex-row justify-content-between align-items-start ">
                                        <!-- Left side: Recommendation text -->
                                        <div class="d-flex flex-column align-items-center me-3"
                                            style="min-height: 200px">
                                            <div class="flex-fill">
                                                <small class="text-muted mb-2" style="font-style: italic;">Rated
                                                    by</small>
                                                <div class="vertical-progress " style="height: 100px; width: 50px;">
                                                    <div class="vertical-progress-bar" th:style="'height: calc(' + ${recommend.percentageOccurrences} + '% + 15px); background-color:' +
                       (${recommend.percentageOccurrences} >= 70 ? '#28a745' :
                        (${recommend.percentageOccurrences} >= 40 ? '#ffc107' : '#dc3545'))">
                                                        <div class="d-flex flex-column align-items-center">
                                                            <span
                                                                th:text="${#numbers.formatDecimal(recommend.percentageOccurrences, 1, 2)} + '%'"></span>
                                                            <small>users</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex-fill">
                                                <span class="badge rounded-pill bg-secondary mb-1 ">
                                                    <i class="ti ti-eye fs-6"></i>
                                                    <a th:href="@{'/anime/' + ${recommend.animeId} }"
                                                        class="text-white">Details</a>
                                                </span>
                                            </div>
                                        </div>
                                        <!-- Right side: Genre pills aligned to right -->
                                        <div class="d-flex flex-column justify-content-center align-items-end ms-auto "
                                            style="min-height: 200px">
                                            <span class="badge bg-secondary mb-2">Genres:</span>
                                            <span th:each="genre : ${recommend.genres}"
                                                class="badge rounded-pill bg-secondary mb-1" th:text="${genre}"></span>
                                        </div>
                                    </div>

                                    <!-- Watchlist Button selection-->
                                    <th:block sec:authorize="isAuthenticated()" th:switch="${recommend.inWatchList}">
                                        <th:block th:case="null">
                                            <div
                                                th:replace="~{fragments/watchBtn :: watchBtnNew(${recommend.getAnimeId()})}">
                                            </div>
                                        </th:block>
                                        <th:block th:case="true">
                                            <div
                                                th:replace="~{fragments/watchBtn :: watchBtnRemove(${recommend.getAnimeId()})}">
                                            </div>
                                        </th:block>
                                        <th:block th:case="false">
                                            <div
                                                th:replace="~{fragments/watchBtn :: watchBtnReAdd(${recommend.getAnimeId()})}">
                                            </div>
                                        </th:block>
                                    </th:block><!--end of selection-->

                                </div><!--end of card inner block of card body-->


                                <!-- Badges -->
                                <div class="d-flex justify-content-between mt-3 ">
                                    <span class="badge bg-success"
                                        th:text="'Avg: ' + ${#numbers.formatDecimal(recommend.getAverageRating(), 1, 2)}">
                                    </span>

                                    <span class="badge bg-info">
                                        <i class="ti ti-world fs-6"></i>
                                        <span th:text="'MAL: ' + ${recommend.animeInfo.score}"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <!--footer-->
    <footer th:replace="~{fragments/footer :: footer}"></footer>
    <th:block th:insert="~{fragments/core :: btScriptInclude}" />
    <th:block th:insert="~{fragments/htmxFragment :: htmxFragment}" />
</body>

</html>